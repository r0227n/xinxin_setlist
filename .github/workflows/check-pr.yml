name: PR Check

on:
  pull_request:
    types: [opened, synchronize, reopened]

concurrency:
  group: check-pr-${{ github.ref }}
  cancel-in-progress: true

jobs:
  check-file-changes:
    name: Check File Changes
    runs-on: ubuntu-24.04
    outputs:
      # File type change counts
      dart_changed: ${{ steps.check_changes.outputs.dart_changed }}
      yml_changed: ${{ steps.check_changes.outputs.yml_changed }}
      yaml_changed: ${{ steps.check_changes.outputs.yaml_changed }}
      md_changed: ${{ steps.check_changes.outputs.md_changed }}
      i18n_changed: ${{ steps.check_changes.outputs.i18n_changed }}
      # Workspace detection
      changed_workspaces: ${{ steps.check_changes.outputs.changed_workspaces }}

    steps:
      # https://github.com/actions/checkout
      - name: Checkout code
        uses: actions/checkout@11bd71901bbe5b1630ceea73d27597364c9af683 # v4.2.2
        with:
          fetch-depth: 0

      # Check for file changes
      - name: Check for file changes
        id: check_changes
        uses: ./.github/actions/check-changes
        with:
          base_sha: ${{ github.event.pull_request.base.sha }}
          head_sha: ${{ github.event.pull_request.head.sha }}

  analyze-and-format:
    name: Analysis and Testing
    runs-on: ubuntu-24.04
    needs: check-file-changes
    if: |
      needs.check-file-changes.outputs.dart_changed != '0' || 
      needs.check-file-changes.outputs.i18n_changed != '0'
    permissions:
      contents: read
      actions: read
      checks: write

    steps:
      # https://github.com/actions/checkout
      - name: Checkout code
        uses: actions/checkout@11bd71901bbe5b1630ceea73d27597364c9af683 # v4.2.2

      - name: Setup Flutter
        uses: ./.github/actions/setup-flutter

      - name: Run analyze for changed workspaces
        if: needs.check-file-changes.outputs.dart_changed != '0'
        env:
          CHANGED_WORKSPACES: ${{ needs.check-file-changes.outputs.changed_workspaces }}
        run: melos run ci:analyze-changed

      - name: Run test for changed workspaces
        if: needs.check-file-changes.outputs.dart_changed != '0'
        env:
          CHANGED_WORKSPACES: ${{ needs.check-file-changes.outputs.changed_workspaces }}
        run: melos run ci:test-changed

      - name: Publish Test Results
        uses: dorny/test-reporter@dc3a92680fcc15842eef52e8c4606ea7ce6bd3f3 # v2.1.1
        if: (success() || failure()) && needs.check-file-changes.outputs.dart_changed != '0'
        with:
          name: Flutter Test Results
          path: '**/test-report.json'
          reporter: 'dart-json'
          fail-on-error: false

      - name: Check format for changed workspaces
        if: needs.check-file-changes.outputs.dart_changed != '0'
        env:
          CHANGED_WORKSPACES: ${{ needs.check-file-changes.outputs.changed_workspaces }}
        run: melos run ci:format-changed

      - name: Validate i18n translations
        if: needs.check-file-changes.outputs.i18n_changed != '0'
        run: melos run analyze:slang

  lint-yaml-markdown:
    name: Lint YAML and Markdown
    runs-on: ubuntu-24.04
    needs: check-file-changes
    if: |
      needs.check-file-changes.outputs.yml_changed != '0' || 
      needs.check-file-changes.outputs.yaml_changed != '0' || 
      needs.check-file-changes.outputs.md_changed != '0'

    steps:
      - name: Checkout code
        uses: actions/checkout@11bd71901bbe5b1630ceea73d27597364c9af683 # v4.2.2

      - name: Setup Bun
        uses: ./.github/actions/setup-bun

      - name: Install dependencies
        run: bun install

      - name: Run Prettier check
        run: bun run ci:check
